<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>手机端实时导航系统</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; }
        #map { height: 100vh; width: 100vw; }
        .control-panel {
            position: absolute; top: 10px; left: 10px; right: 10px; z-index: 1000;
            background: white; padding: 12px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        input {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;
            font-size: 16px; margin-bottom: 8px; box-sizing: border-box;
        }
        .btn-group { display: flex; gap: 8px; }
        button {
            flex: 1; padding: 12px; border: none; border-radius: 4px;
            color: white; font-weight: bold; font-size: 14px; cursor: pointer;
        }
        #bestBtn { background-color: #007AFF; } /* 蓝色表示最优 */
        #altBtn { background-color: #34C759; }  /* 绿色表示备选 */
        .info {
            position: absolute; bottom: 20px; left: 10px; z-index: 1000;
            background: rgba(255,255,255,0.9); padding: 5px 10px; border-radius: 4px; font-size: 12px;
        }
    </style>
</head>
<body>

<div class="control-panel">
    <input type="text" id="destInput" placeholder="输入目的地名称 (如: 81-82)...">
    <div class="btn-group">
        <button id="bestBtn" onclick="startNav('best')">最优路径</button>
        <button id="altBtn" onclick="startNav('alt')">舒适备选</button>
    </div>
</div>

<div id="map"></div>
<div class="info" id="status">定位中...</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/geojson-path-finder/dist/geojson-path-finder.min.js"></script>

<script>
    // 1. 初始化地图 (默认中心点设为您数据所在区域)
    const map = L.map('map').setView([22.527, 113.932], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let roadsData, userLocation, routeLayer, userMarker;

    // 2. 加载您导出的 roads.json
    fetch('roads.json')
        .then(response => response.json())
        .then(data => {
            roadsData = data;
            // 在地图上微弱显示路网作为底图
            L.geoJSON(data, { style: { color: '#ddd', weight: 1, opacity: 0.5 } }).addTo(map);
            document.getElementById('status').innerText = "路网加载完成";
        });

    // 3. 开启手机 GPS 实时定位
    map.locate({ setView: true, watch: true, enableHighAccuracy: true });

    map.on('locationfound', (e) => {
        userLocation = e.latlng;
        document.getElementById('status').innerText = "实时定位中";
        
        if (!userMarker) {
            userMarker = L.circleMarker(e.latlng, { radius: 8, color: '#007AFF', fillColor: '#007AFF', fillOpacity: 1 }).addTo(map);
        } else {
            userMarker.setLatLng(e.latlng);
        }
    });

    // 4. 导航计算核心逻辑
    function startNav(type) {
        const destName = document.getElementById('destInput').value;
        if (!roadsData || !userLocation) return alert("请等待定位或数据加载");

        // 在路网中寻找目的地匹配的点
        const target = roadsData.features.find(f => f.properties.name === destName || f.properties.roadname === destName);
        if (!target) return alert("未找到该目的地，请输入属性表中的 roadname");

        // 配置权重函数实现最优与备选
        const pathFinder = new geojsonPathFinder(roadsData, {
            weightFn: (a, b, props) => {
                const baseLen = props.length || 0.1;
                if (type === 'best') {
                    return baseLen; // 最优：只看长度
                } else {
                    // 备选：宽度越小阻力越大，环境成本越高阻力越大
                    const widthFactor = (props.width < 3) ? 10 : 1; 
                    const envFactor = props.env || 1;
                    return baseLen * widthFactor * envFactor;
                }
            }
        });

        // 计算路径 (起点为当前 GPS，终点为匹配路段的第一个坐标)
        const start = { geometry: { coordinates: [userLocation.lng, userLocation.lat] } };
        const end = { geometry: { coordinates: target.geometry.coordinates[0] } };
        
        const result = pathFinder.findPath(start, end);

        if (result) {
            if (routeLayer) map.removeLayer(routeLayer);
            const routeColor = (type === 'best') ? '#007AFF' : '#34C759';
            routeLayer = L.polyline(result.path.map(p => [p[1], p[0]]), { color: routeColor, weight: 6, opacity: 0.8 }).addTo(map);
            map.fitBounds(routeLayer.getBounds());
        } else {
            alert("无法计算路径，请检查路网连通性");
        }
    }
</script>
</body>
</html>