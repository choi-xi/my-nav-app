<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>æ·±å¤§æ™ºèƒ½å¯¼èˆª - è°ƒè¯•ä¿®å¤ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        :root { --bg: #f8f9fa; --accent: #800000; --blue: #007AFF; --panel: rgba(255,255,255,0.98); }
        body { margin: 0; background: var(--bg); font-family: -apple-system, sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100vw; transition: height 0.4s ease; background: #ddd; }
        #map.shrink { height: 60vh; }
        .top-bar { position: absolute; top: 15px; width: 92%; left: 4%; z-index: 1000; display: flex; gap: 8px; }
        #destInput { flex: 1; padding: 12px 16px; border-radius: 12px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); background: var(--panel); font-size: 16px; outline: none; }
        .action-btn { background: var(--blue); color: white; border: none; padding: 0 20px; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 40vh; background: var(--panel); transform: translateY(100%); transition: transform 0.4s; z-index: 1001; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); overflow-y: auto; }
        .bottom-nav.show { transform: translateY(0); }
        .nav-content { padding: 20px; border-top: 4px solid var(--accent); }
        .locate-btn { position: absolute; right: 15px; bottom: 25px; z-index: 1002; width: 50px; height: 50px; border-radius: 50%; background: #fff; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.15); font-size: 24px; transition: 0.4s; }
        .locate-btn.up { bottom: calc(40vh + 20px); }
        #status-bar { position: absolute; top: 75px; left: 5%; z-index: 1000; font-size: 11px; background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 4px; color: #fff; }
    </style>
</head>
<body>

<div class="top-bar">
    <input type="text" id="destInput" list="pointsList" placeholder="æœåœ°ç‚¹ (å¦‚: æ±‡å…¸æ¥¼)...">
    <datalist id="pointsList"></datalist>
    <button class="action-btn" onclick="triggerNav()">å¯¼èˆª</button>
</div>
<div id="status-bar">ç³»ç»Ÿå‡†å¤‡ä¸­...</div>
<button class="locate-btn" id="locateBtn" onclick="requestLocation()">ğŸ¯</button>
<div id="map"></div>

<div class="bottom-nav" id="bottomNav">
    <div class="nav-content">
        <h3 id="targetName" style="margin:0 0 10px 0; color:var(--accent);">ç›®çš„åœ°</h3>
        <p id="routeInfo" style="margin:0; font-size:15px; color:#444;">æ­£åœ¨è®¡ç®—æœ€ä½³è·¯çº¿...</p>
        <button onclick="location.reload()" style="margin-top:20px; width:100%; padding:12px; border:none; background:#eee; border-radius:8px; font-weight:bold;">æ¸…é™¤è·¯å¾„</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/geojson-path-finder/dist/geojson-path-finder.min.js"></script>

<script>
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([22.532, 113.936], 16);
    let roadsData, pointsData, userLocation = null, currentRouteLayer = null;

    const styles = {
        green: { fillColor: "#C8E6C9", color: "#A5D6A7", weight: 0.5, fillOpacity: 0.7 },
        water: { fillColor: "#B3E5FC", color: "#81D4FA", weight: 0.5, fillOpacity: 0.8 },
        buildings: { fillColor: "#E0E0E0", color: "#BDBDBD", weight: 0.5, fillOpacity: 0.85 },
        roads: { color: "#ffffff", weight: 3, opacity: 0.7 }
    };

    async function init() {
        try {
            const [g, w, b, r, p] = await Promise.all([
                fetch('green.json').then(res => res.json()),
                fetch('water.json').then(res => res.json()),
                fetch('buildings.json').then(res => res.json()),
                fetch('roads.json').then(res => res.json()),
                fetch('points.json').then(res => res.json())
            ]);

            L.geoJSON(g, { style: styles.green }).addTo(map);
            L.geoJSON(w, { style: styles.water }).addTo(map);
            L.geoJSON(b, { style: styles.buildings }).addTo(map);
            L.geoJSON(r, { style: styles.roads }).addTo(map);

            // ã€å…³é”®ä¿®å¤ã€‘æ·±åº¦æ¸…æ´—è·¯ç½‘æ•°æ®
            r.features = r.features.filter(f => f.geometry && f.geometry.coordinates);
            r.features.forEach((f, i) => {
                f.properties.id = i;
                let c = f.geometry.coordinates;
                // 1. å¤„ç† ArcMap çš„åµŒå¥— MultiLine é—®é¢˜
                if (Array.isArray(c[0][0])) c = c[0];
                // 2. å¼ºåˆ¶è½¬ä¸ºäºŒç»´ [lng, lat]ï¼Œè¿‡æ»¤æ‰ null æˆ– Z è½´
                f.geometry.coordinates = c.map(pt => [pt[0], pt[1]]);
            });

            roadsData = r;
            pointsData = p;

            // å¡«å……æœç´¢å»ºè®®
            const list = document.getElementById('pointsList');
            L.geoJSON(p, {
                pointToLayer: (f, latlng) => L.circleMarker(latlng, { radius: 5, fillColor: "#800000", color: "#fff", weight: 1.5, fillOpacity: 1 }),
                onEachFeature: (f, layer) => {
                    const name = f.properties.name || "æœªå‘½ååœ°ç‚¹";
                    const opt = document.createElement('option');
                    opt.value = name;
                    list.appendChild(opt);
                    layer.bindPopup(`<b>${name}</b><br><button onclick="startNav('${name}')" style="margin-top:5px;cursor:pointer;">è®¾ä¸ºç»ˆç‚¹</button>`);
                }
            }).addTo(map);

            document.getElementById('status-bar').innerText = "åœ°å›¾åŠ è½½æˆåŠŸï¼Œè¯·ç‚¹å‡»é“è·¯è®¾ç½®èµ·ç‚¹";
        } catch (e) {
            console.error("åˆå§‹åŒ–é”™è¯¯:", e);
            document.getElementById('status-bar').innerText = "æ•°æ®é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°";
        }
    }

    function requestLocation() {
        map.locate({ setView: true, enableHighAccuracy: true });
    }

    map.on('locationfound', e => {
        userLocation = e.latlng;
        drawUserMarker(e.latlng);
        document.getElementById('status-bar').innerText = "å·²å®šä½åˆ°å½“å‰ä½ç½®";
    });

    map.on('click', e => {
        userLocation = e.latlng;
        drawUserMarker(e.latlng);
        document.getElementById('status-bar').innerText = "èµ·ç‚¹ï¼šæ‰‹åŠ¨ç‚¹å‡»ä½ç½®";
    });

    function drawUserMarker(latlng) {
        if (!window.uM) window.uM = L.circleMarker(latlng, { radius: 8, fillColor: '#007AFF', color: '#fff', weight: 3, fillOpacity: 1 }).addTo(map);
        else window.uM.setLatLng(latlng);
    }

    function triggerNav() {
        const val = document.getElementById('destInput').value;
        if (val) startNav(val);
        else alert("è¯·è¾“å…¥ç›®çš„åœ°åç§°");
    }

    function startNav(name) {
        console.log("å‡†å¤‡å¯¼èˆªè‡³:", name);
        if (!userLocation) return alert("è¯·å…ˆç‚¹å‡»åœ°å›¾æˆ– ğŸ¯ è®¾ç½®èµ·ç‚¹");
        
        const targetFeature = pointsData.features.find(f => f.properties.name === name);
        if (!targetFeature) return alert("æœªæ‰¾åˆ°è¯¥åœ°ç‚¹");

        // è·¯å¾„æŸ¥æ‰¾å¼•æ“é…ç½®
        try {
            const finder = new geojsonPathFinder(roadsData, {
                precision: 0.0001,
                weightFn: (a, b, p) => {
                    const dx = a[0] - b[0];
                    const dy = a[1] - b[1];
                    return Math.sqrt(dx * dx + dy * dy);
                }
            });

            const start = { geometry: { coordinates: [userLocation.lng, userLocation.lat] } };
            const end = { geometry: { coordinates: targetFeature.geometry.coordinates } };

            console.log("å¼€å§‹è®¡ç®—è·¯å¾„...");
            const result = finder.findPath(start, end);

            if (result && result.path) {
                if (currentRouteLayer) map.removeLayer(currentRouteLayer);
                
                const latlngs = result.path.map(pt => [pt[1], pt[0]]);
                currentRouteLayer = L.polyline(latlngs, { color: '#800000', weight: 8, opacity: 0.9, lineJoin: 'round' }).addTo(map);
                
                document.getElementById('targetName').innerText = name;
                document.getElementById('routeInfo').innerText = `æ‰¾åˆ°è·¯å¾„ï¼çº¦ ${Math.round(result.weight * 100000)} ç±³ã€‚`;
                document.getElementById('bottomNav').classList.add('show');
                document.getElementById('map').classList.add('shrink');
                document.getElementById('locateBtn').classList.add('up');
                
                map.fitBounds(currentRouteLayer.getBounds(), { padding: [50, 50] });
            } else {
                alert("å¯¼èˆªå¤±è´¥ï¼šæ‚¨çš„èµ·ç‚¹æˆ–ç»ˆç‚¹ç¦»é“è·¯å¤ªè¿œï¼Œè¯·å°è¯•ç‚¹å‡»ç™½è‰²è·¯çº¿ä¸Šã€‚");
            }
        } catch (err) {
            console.error("è·¯å¾„ç®—æ³•å´©æºƒ:", err);
            alert("è·¯å¾„è®¡ç®—å‡ºé”™ï¼Œè¯·æ£€æŸ¥è·¯ç½‘è¿é€šæ€§");
        }
    }

    init();
</script>
</body>
</html>
