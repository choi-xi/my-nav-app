<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>æ·±å¤§æ™ºèƒ½å¯¼èˆª - æœ€ç»ˆä¿®å¤ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        :root { --bg: #ffffff; --text: #333; --panel: rgba(255,255,255,0.98); --accent: #800000; --blue: #007AFF; }
        body.dark-mode { --bg: #121212; --text: #e0e0e0; --panel: rgba(30,30,30,0.98); --accent: #ff4d4d; }
        body { margin: 0; background: var(--bg); font-family: -apple-system, sans-serif; overflow: hidden; }
        
        /* æ ¸å¿ƒå®¹å™¨å±‚çº§ï¼šåº•å›¾åœ¨ä¸‹ï¼Œç‚¹åœ¨ä¸Š */
        #map { height: 100vh; width: 100vw; background: #f8f8f8; transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1; }
        #map.shrink { height: 60vh; }

        .top-bar { position: absolute; top: 15px; width: 92%; left: 4%; z-index: 1000; display: flex; gap: 8px; }
        #destInput { flex: 1; padding: 12px 18px; border-radius: 12px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); font-size: 16px; background: var(--panel); color: var(--text); outline: none; }
        
        .action-btn { background: var(--blue); color: white; border: none; padding: 0 15px; border-radius: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,122,255,0.3); }
        .theme-btn { background: var(--panel); border: none; width: 45px; height: 45px; border-radius: 12px; cursor: pointer; font-size: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }

        .bottom-nav { 
            position: fixed; bottom: 0; width: 100%; height: 40vh; 
            background: var(--panel); color: var(--text); 
            z-index: 1001; transform: translateY(100%); 
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }
        .bottom-nav.show { transform: translateY(0); }

        .nav-tabs { display: flex; height: 100%; }
        .nav-card { flex: 1; padding: 15px 12px; border-right: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; cursor: pointer; }
        .nav-card.active { border-top: 4px solid var(--accent); background: rgba(128, 0, 0, 0.05); }
        .nav-card h4 { margin: 0 0 8px 0; font-size: 14px; color: var(--accent); }
        .nav-card .desc { font-size: 11px; line-height: 1.5; color: #666; }

        .locate-btn { position: absolute; right: 15px; bottom: 20px; z-index: 1002; width: 50px; height: 50px; border-radius: 50%; background: #fff; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 24px; transition: bottom 0.5s; }
        .locate-btn.up { bottom: calc(40vh + 20px); }

        /* ä¿®å¤ Popup æ ·å¼ä½¿å…¶å¯è§ */
        .leaflet-popup { z-index: 2000 !important; }
    </style>
</head>
<body>

<div class="top-bar">
    <input type="text" id="destInput" list="pointsList" placeholder="æœç´¢æ·±å¤§åœ°ç‚¹...">
    <datalist id="pointsList"></datalist>
    <button class="action-btn" onclick="triggerNav()">å¯¼èˆª</button>
    <button class="theme-btn" onclick="toggleTheme()">ğŸŒ“</button>
</div>

<button class="locate-btn" id="locateBtn" onclick="requestLocation()">ğŸ¯</button>
<div id="map"></div>

<div class="bottom-nav" id="bottomNav">
    <div class="nav-tabs">
        <div class="nav-card active" id="card-best" onclick="displayRoute('best')">
            <h4 id="h-best">æ¨èè·¯çº¿</h4>
            <div class="desc" id="d-best">æ­£åœ¨åˆ†æ...</div>
        </div>
        <div class="nav-card" id="card-alt1" onclick="displayRoute('alt1')">
            <h4>æœ€çŸ­è·ç¦»</h4>
            <div class="desc" id="d-alt1">â€”â€”</div>
        </div>
        <div class="nav-card" id="card-alt2" onclick="displayRoute('alt2')">
            <h4>æ›´å®½å¦é€”</h4>
            <div class="desc" id="d-alt2">â€”â€”</div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/geojson-path-finder/dist/geojson-path-finder.min.js"></script>

<script>
    // 1. è®¾ç½®åæ ‡ä¸åœ°å›¾
    const imageBounds = [[22.525063791, 113.92663566], [22.5394650408, 113.946736297]];
    const map = L.map('map', { 
        maxBounds: imageBounds, 
        zoomControl: false,
        attributionControl: false
    }).setView([22.532, 113.936], 16);
    
    // å…³é”®ï¼šé™ä½åº•å›¾å±‚çº§ (zIndex)
    const groundLayer = L.imageOverlay('szu_base.png', imageBounds, { 
        zIndex: 1, 
        interactive: true 
    }).addTo(map);

    let isNight = false, roadsData, pointsData, userLocation = null;
    let routes = { best: null, alt1: null, alt2: null };
    let currentLayers = [];

    // 2. åŠ è½½æ•°æ®
    Promise.all([
        fetch('roads.json').then(r => r.json()),
        fetch('points.json').then(r => r.json())
    ]).then(([roads, points]) => {
        // æ•°æ®æ¸…æ´—
        roads.features.forEach((f, i) => {
            f.properties.id = f.properties.id || `r_${i}`;
            f.geometry.coordinates = f.geometry.coordinates.map(c => [parseFloat(c[0]), parseFloat(c[1])]);
        });
        roadsData = roads;
        pointsData = points;
        
        // æ¸²æŸ“ç‚¹ (æé«˜ zIndex å¹¶ä½¿ç”¨æ˜¾çœ¼çš„é¢œè‰²)
        L.geoJSON(points, {
            pointToLayer: (f, latlng) => {
                const marker = L.circleMarker(latlng, {
                    radius: 7,
                    fillColor: "#800000",
                    color: "#fff",
                    weight: 2,
                    fillOpacity: 1,
                    pane: 'markerPane' // ç¡®ä¿ç‚¹åœ¨é¡¶å±‚
                });
                return marker;
            },
            onEachFeature: (f, layer) => {
                layer.bindPopup(`<b>${f.properties.name}</b><br><button onclick="startNavigation('${f.properties.name}')" style="background:#007AFF;color:#fff;border:none;padding:5px 10px;border-radius:4px;margin-top:5px;width:100%">è®¾ä¸ºç»ˆç‚¹</button>`);
                const opt = document.createElement('option');
                opt.value = f.properties.name;
                document.getElementById('pointsList').appendChild(opt);
            }
        }).addTo(map);
    });

    // 3. å®šä½é€»è¾‘
    function requestLocation() {
        map.locate({ setView: true, enableHighAccuracy: true });
    }

    map.on('locationfound', e => {
        userLocation = e.latlng;
        updateUserMarker(e.latlng);
    });

    // æ¨¡æ‹Ÿç‚¹å‡»å®šä½ (å¦‚æœä½ åœ¨å®¤å†…æ²¡ä¿¡å·ï¼Œç‚¹å‡»åœ°å›¾ä»»æ„ç‚¹å³å¯å¼€å§‹å¯¼èˆª)
    map.on('click', e => {
        userLocation = e.latlng;
        updateUserMarker(e.latlng);
    });

    function updateUserMarker(latlng) {
        if(!window.userMarker) {
            window.userMarker = L.circleMarker(latlng, {radius: 10, color: '#fff', weight: 3, fillColor: '#007AFF', fillOpacity: 1, pane: 'markerPane'}).addTo(map);
        } else {
            window.userMarker.setLatLng(latlng);
        }
    }

    // 4. å¯¼èˆªé€»è¾‘
    function triggerNav() {
        const val = document.getElementById('destInput').value;
        if(val) startNavigation(val);
        else alert("è¯·è¾“å…¥åœ°ç‚¹æˆ–ç›´æ¥ç‚¹å‡»åœ°å›¾ä¸Šçš„ç‚¹");
    }

    function startNavigation(name) {
        if(!userLocation) return alert("è¯·å…ˆç‚¹å‡»å³ä¸‹è§’ ğŸ¯ å®šä½ï¼Œæˆ–ç›´æ¥ç‚¹å‡»åœ°å›¾è®¾ç½®èµ·ç‚¹");
        
        const target = pointsData.features.find(f => f.properties.name === name);
        if(!target) return;

        // æ ¸å¿ƒç®—æ³•ï¼šå¢åŠ ç²¾åº¦å®¹é”™
        const finder = new geojsonPathFinder(roadsData, {
            precision: 0.0001, // å¢åŠ åŒ¹é…ç²¾åº¦
            weightFn: (a, b, p) => p.length
        });

        const path = finder.findPath(
            { geometry: { coordinates: [userLocation.lng, userLocation.lat] } },
            { geometry: { coordinates: target.geometry.coordinates } }
        );

        if(path) {
            routes.best = path;
            document.getElementById('bottomNav').classList.add('show');
            document.getElementById('map').classList.add('shrink');
            document.getElementById('locateBtn').classList.add('up');
            displayRoute('best');
            updateUI();
        } else {
            alert("æ— æ³•è§„åˆ’è·¯çº¿ï¼šèµ·ç‚¹ç¦»è·¯ç½‘å¤ªè¿œï¼Œè¯·å°è¯•ç‚¹å‡»æ ¡é“é™„è¿‘çš„ä½ç½®");
        }
    }

    function displayRoute(type) {
        currentLayers.forEach(l => map.removeLayer(l));
        currentLayers = [];
        const r = routes[type];
        if(r) {
            const poly = L.polyline(r.path.map(p => [p[1], p[0]]), {
                color: '#800000', 
                weight: 8, 
                opacity: 0.8,
                pane: 'overlayPane'
            }).addTo(map);
            currentLayers.push(poly);
            map.fitBounds(poly.getBounds(), {padding: [50, 50]});
        }
    }

    function updateUI() {
        const r = routes.best;
        if(r) document.getElementById('d-best').innerText = `è·¯ç¨‹: ${Math.round(r.weight*100)} ç±³`;
    }

    function toggleTheme() {
        isNight = !isNight;
        document.body.classList.toggle('dark-mode');
        const img = groundLayer.getElement();
        if(img) img.style.filter = isNight ? "brightness(0.4) contrast(1.2) hue-rotate(180deg)" : "none";
    }
</script>
</body>
</html>
