<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>æ·±å¤§æ™ºèƒ½å¯¼èˆª - ä¿®å¤ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        :root { --bg: #ffffff; --text: #333; --panel: rgba(255,255,255,0.95); --accent: #800000; }
        body.dark-mode { --bg: #121212; --text: #e0e0e0; --panel: rgba(30,30,30,0.95); --accent: #ff4d4d; }
        body { margin: 0; transition: background 0.8s ease; background: var(--bg); font-family: -apple-system, sans-serif; overflow: hidden; }
        #map { height: 60vh; width: 100vw; background: #eee; transition: filter 0.8s ease; }
        .top-bar { position: absolute; top: 15px; width: 90%; left: 5%; z-index: 1000; display: flex; gap: 10px; }
        #destInput { flex: 1; padding: 12px 20px; border-radius: 25px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.15); font-size: 16px; background: var(--panel); color: var(--text); outline: none; }
        .theme-btn { background: var(--panel); border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 40vh; background: var(--panel); color: var(--text); display: flex; flex-direction: column; border-top: 1px solid rgba(0,0,0,0.1); z-index: 1001; }
        .nav-tabs { display: flex; height: 100%; }
        .nav-card { flex: 1; padding: 15px 10px; border-right: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; cursor: pointer; transition: 0.3s; }
        .nav-card.active { background: rgba(128, 0, 0, 0.08); border-top: 4px solid var(--accent); }
        .nav-card h4 { margin: 0 0 8px 0; font-size: 14px; color: var(--accent); }
        .nav-card .desc { font-size: 11px; line-height: 1.5; color: #666; overflow-y: auto; flex-grow: 1; }
        .nav-btn { background: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-top: 10px; cursor: pointer; width: 100%; font-weight: bold; }
        /* è°ƒè¯•æç¤º */
        #debug-info { position: absolute; top: 70px; left: 5%; background: rgba(0,0,0,0.6); color: #fff; padding: 5px 10px; border-radius: 5px; font-size: 10px; z-index: 1000; pointer-events: none; }
    </style>
</head>
<body>

<div class="top-bar">
    <input type="text" id="destInput" list="pointsList" placeholder="æœç´¢æ·±å¤§åœ°ç‚¹..." oninput="checkInput(this.value)">
    <datalist id="pointsList"></datalist>
    <button class="theme-btn" onclick="toggleTheme()">ğŸŒ“</button>
</div>
<div id="debug-info">æ­£åœ¨åŠ è½½æ•°æ®...</div>
<div id="map"></div>

<div class="bottom-nav">
    <div class="nav-tabs">
        <div class="nav-card" id="card-best" onclick="displayRoute('best')">
            <h4 id="h-best">èˆ’é€‚æœ€ä¼˜</h4>
            <div class="desc" id="d-best">è¯·å…ˆå…è®¸å®šä½æˆ–ç‚¹å‡»åœ°å›¾</div>
        </div>
        <div class="nav-card" id="card-alt1" onclick="displayRoute('alt1')">
            <h4 id="h-alt1">å¤‡é€‰ï¼šæ›´çŸ­</h4>
            <div class="desc" id="d-alt1">â€”â€”</div>
        </div>
        <div class="nav-card" id="card-alt2" onclick="displayRoute('alt2')">
            <h4 id="h-alt2">å¤‡é€‰ï¼šæ›´å®‰å…¨</h4>
            <div class="desc" id="d-alt2">â€”â€”</div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/geojson-path-finder/dist/geojson-path-finder.min.js"></script>

<script>
    const imageBounds = [[22.525063791, 113.92663566], [22.5394650408, 113.946736297]];
    const map = L.map('map', { maxBounds: imageBounds, maxBoundsViscosity: 1.0, minZoom: 15 }).setView([22.532, 113.936], 16);
    
    const groundLayer = L.imageOverlay('szu_base.png', imageBounds, { opacity: 1, zIndex: 1, interactive: true }).addTo(map);

    let isNight = false, roadsData, pointsData, userLocation;
    let routes = { best: null, alt1: null, alt2: null };
    let currentLayers = [];

    // 1. æ•°æ®åŠ è½½ä¸ã€æ·±åº¦æ¸…æ´—ã€‘
    Promise.all([
        fetch('roads.json').then(r => r.json()),
        fetch('points.json').then(r => r.json())
    ]).then(([roads, points]) => {
        // æ¸…æ´— roads.jsonï¼šç§»é™¤ coordinates ä¸­çš„ç¬¬3ä¸ª null å€¼ï¼Œå¹¶ç¡®ä¿æœ‰ ID
        roads.features = roads.features.filter(f => f.geometry && f.geometry.coordinates);
        roads.features.forEach((f, i) => {
            f.properties.id = f.properties.id || `r_${i}`;
            f.geometry.coordinates = f.geometry.coordinates.map(c => [parseFloat(c[0]), parseFloat(c[1])]);
        });
        
        roadsData = roads;
        pointsData = points;
        document.getElementById('debug-info').innerText = "æ•°æ®å·²å°±ç»ªï¼Œç­‰å¾…å®šä½...";

        const list = document.getElementById('pointsList');
        L.geoJSON(points, {
            pointToLayer: (f, l) => {
                const opt = document.createElement('option');
                opt.value = f.properties.name;
                list.appendChild(opt);
                return L.circleMarker(l, { radius: 5, color: '#800000', opacity: 0 });
            },
            onEachFeature: (f, layer) => {
                layer.bindPopup(`<b>${f.properties.name}</b><br><button class="nav-btn" onclick="startNavigation('${f.properties.name}')">åˆ°è¿™é‡Œå»</button>`);
            }
        }).addTo(map);
    }).catch(err => {
        document.getElementById('debug-info').innerText = "æ•°æ®åŠ è½½å¤±è´¥: " + err;
    });

    // 2. å®šä½å¤„ç†ï¼ˆåŒ…å«è°ƒè¯•æ¨¡æ‹ŸåŠŸèƒ½ï¼‰
    map.on('locationfound', e => {
        userLocation = e.latlng;
        updateUserMarker(e.latlng);
        document.getElementById('debug-info').innerText = "å®šä½æˆåŠŸ (WGS84)";
    });

    // å¦‚æœæ‰‹æœºå®šä½ä¸å‡†ï¼Œå…è®¸ç‚¹å‡»åœ°å›¾æ‰‹åŠ¨è®¾ç½®â€œæˆ‘çš„ä½ç½®â€è¿›è¡Œæµ‹è¯•
    map.on('click', e => {
        userLocation = e.latlng;
        updateUserMarker(e.latlng);
        document.getElementById('debug-info').innerText = "æ‰‹åŠ¨è®¾ç½®èµ·ç‚¹: " + e.latlng.lat.toFixed(4) + "," + e.latlng.lng.toFixed(4);
    });

    function updateUserMarker(latlng) {
        if(!window.userMarker) window.userMarker = L.circleMarker(latlng, {radius: 8, color: '#fff', weight: 2, fillColor: '#007AFF', fillOpacity: 1, zIndexOffset: 1000}).addTo(map);
        else window.userMarker.setLatLng(latlng);
    }

    map.locate({setView: true, watch: true, enableHighAccuracy: true});

    // 3. å¯¼èˆªæ ¸å¿ƒé€»è¾‘
    async function startNavigation(name) {
        if(!userLocation) return alert("è¯·å…ˆå¼€å¯å®šä½æˆ–åœ¨åœ°å›¾ä¸Šç‚¹å‡»é€‰æ‹©ä½ çš„ä½ç½®");
        
        document.getElementById('destInput').value = name;
        const target = pointsData.features.find(f => f.properties.name === name);
        if(!target) return;
        map.closePopup();

        // å°è¯•è®¡ç®—è·¯å¾„
        try {
            routes.best = calculatePath('best', target.geometry.coordinates);
            if(!routes.best) throw new Error("æ— æ³•è¿æ¥åˆ°è·¯ç½‘");
            
            const bestIds = routes.best.edgeInfos.map(e => e.id);
            routes.alt1 = calculatePath('alt1', target.geometry.coordinates, bestIds);
            routes.alt2 = calculatePath('alt2', target.geometry.coordinates, [...bestIds, ...(routes.alt1?.edgeInfos.map(e => e.id) || [])]);

            updateUI();
            displayRoute('best');
            document.getElementById('debug-info').innerText = "è§„åˆ’å®Œæˆ";
        } catch (e) {
            document.getElementById('debug-info').innerText = "è§„åˆ’å¤±è´¥: èµ·ç‚¹æˆ–ç»ˆç‚¹ä¸åœ¨è·¯ç½‘èŒƒå›´å†…";
            alert("è§„åˆ’å¤±è´¥ï¼šè¯·å°è¯•ç§»åŠ¨åˆ°æœ€è¿‘çš„æ ¡é“ä¸Šå†é‡è¯•ã€‚");
        }
    }

    function calculatePath(type, destCoords, penaltyIds = []) {
        // åˆ›å»ºè·¯å¾„æŸ¥æ‰¾å™¨å®ä¾‹
        const finder = new geojsonPathFinder(roadsData, {
            weightFn: (a, b, props) => {
                const { length: L, width: W, env: E, safe: S } = props;
                const penalty = penaltyIds.includes(props.id) ? 100 : 1;
                let w = 0;
                if(!isNight){
                    if(type === 'best') w = (L*0.2 + W*0.2 + E*0.4 + S*0.2);
                    if(type === 'alt1') w = (L*0.7 + W*0.2 + E*0.1); // å¢å¼ºé•¿åº¦å æ¯”
                    if(type === 'alt2') w = (L*0.3 + W*0.3 + S*0.4);
                } else {
                    if(type === 'best') w = (L*0.2 + W*0.2 + E*0.2 + S*0.4);
                    if(type === 'alt1') w = (L*0.7 + W*0.1 + S*0.2);
                    if(type === 'alt2') w = (L*0.2 + W*0.2 + S*0.2 + E*0.4);
                }
                return w * penalty;
            }
        });

        // æŸ¥æ‰¾è·¯å¾„
        return finder.findPath(
            { geometry: { coordinates: [userLocation.lng, userLocation.lat] } },
            { geometry: { coordinates: destCoords } }
        );
    }

    function displayRoute(type) {
        currentLayers.forEach(l => map.removeLayer(l));
        currentLayers = [];
        document.querySelectorAll('.nav-card').forEach(c => c.classList.remove('active'));
        document.getElementById('card-' + type).classList.add('active');

        const r = routes[type];
        if(r) {
            const color = type === 'best' ? '#800000' : (type === 'alt1' ? '#007AFF' : '#34C759');
            const poly = L.polyline(r.path.map(p => [p[1], p[0]]), {color, weight: 8, opacity: 0.8, lineJoin: 'round'}).addTo(map);
            currentLayers.push(poly);
            map.fitBounds(poly.getBounds(), {padding: [50, 50]});
        }
    }

    function updateUI() {
        ['best', 'alt1', 'alt2'].forEach(t => {
            const r = routes[t];
            const div = document.getElementById('d-'+t);
            if(r) {
                const dist = (r.weight * 100).toFixed(0);
                div.innerHTML = `é¢„è®¡: ${dist}ç±³<br>è·¯çº¿å·²ç”Ÿæˆ`;
            } else { div.innerHTML = "ä¸å¯è¾¾"; }
        });
    }

    function toggleTheme() {
        isNight = !isNight;
        document.body.classList.toggle('dark-mode');
        const img = groundLayer.getElement();
        if(img) img.style.filter = isNight ? "brightness(0.4) contrast(1.2) hue-rotate(180deg)" : "none";
        if(document.getElementById('destInput').value) startNavigation(document.getElementById('destInput').value);
    }

    function checkInput(val) {
        if(pointsData.features.some(f => f.properties.name === val)) startNavigation(val);
    }
</script>
</body>
</html>