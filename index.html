<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>æ·±å¤§æ™ºèƒ½å¯¼èˆª - äº¤äº’ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        :root { --bg: #ffffff; --text: #333; --panel: rgba(255,255,255,0.98); --accent: #800000; --blue: #007AFF; }
        body.dark-mode { --bg: #121212; --text: #e0e0e0; --panel: rgba(30,30,30,0.98); --accent: #ff4d4d; }
        
        body { margin: 0; background: var(--bg); font-family: -apple-system, sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100vw; background: #eee; transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        #map.shrink { height: 60vh; } /* å¯¼èˆªå¼€å¯ååœ°å›¾ç¼©å° */

        /* æœç´¢æ ä¸æŒ‰é”® */
        .top-bar { position: absolute; top: 15px; width: 92%; left: 4%; z-index: 1000; display: flex; gap: 8px; }
        #destInput { flex: 1; padding: 12px 18px; border-radius: 12px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); font-size: 16px; background: var(--panel); color: var(--text); outline: none; }
        
        .action-btn { background: var(--blue); color: white; border: none; padding: 0 15px; border-radius: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,122,255,0.3); display: flex; align-items: center; justify-content: center; }
        .theme-btn { background: var(--panel); border: none; width: 45px; height: 45px; border-radius: 12px; cursor: pointer; font-size: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }

        /* çŠ¶æ€æç¤º */
        #status-bar { position: absolute; top: 75px; left: 4%; z-index: 1000; background: rgba(0,0,0,0.6); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; opacity: 0.8; }

        /* åº•éƒ¨è·¯çº¿é¢æ¿ï¼šé»˜è®¤éšè—å¹¶ä¸‹æ²‰ */
        .bottom-nav { 
            position: fixed; bottom: 0; width: 100%; height: 40vh; 
            background: var(--panel); color: var(--text); 
            border-top: 1px solid rgba(0,0,0,0.1); z-index: 1001;
            transform: translateY(100%); /* éšè—åœ¨å±å¹•ä¸‹æ–¹ */
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }
        .bottom-nav.show { transform: translateY(0); } /* åŠ¨ç”»å‡èµ· */

        .nav-tabs { display: flex; height: 100%; }
        .nav-card { flex: 1; padding: 15px 12px; border-right: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; cursor: pointer; }
        .nav-card.active { background: rgba(128, 0, 0, 0.05); border-top: 4px solid var(--accent); }
        .nav-card h4 { margin: 0 0 8px 0; font-size: 14px; color: var(--accent); }
        .nav-card .desc { font-size: 11px; line-height: 1.5; color: #666; flex-grow: 1; }
        
        /* å®šä½æŒ‰é’®æ ·å¼ */
        .locate-btn { position: absolute; right: 15px; bottom: 20px; z-index: 1000; width: 45px; height: 45px; border-radius: 50%; background: var(--panel); border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-size: 20px; transition: bottom 0.5s; }
        .locate-btn.up { bottom: calc(40vh + 20px); }
    </style>
</head>
<body>

<div class="top-bar">
    <input type="text" id="destInput" list="pointsList" placeholder="è¦å»å“ªé‡Œï¼Ÿ" oninput="checkInput(this.value)">
    <datalist id="pointsList"></datalist>
    <button class="action-btn" onclick="triggerNav()">å¯¼èˆª</button>
    <button class="theme-btn" onclick="toggleTheme()">ğŸŒ“</button>
</div>

<div id="status-bar">å°±ç»ª | ç‚¹å‡»åœ°å›¾å¯æ¨¡æ‹Ÿä½ç½®</div>

<button class="locate-btn" id="locateBtn" onclick="requestLocation()">ğŸ¯</button>

<div id="map"></div>

<div class="bottom-nav" id="bottomNav">
    <div class="nav-tabs">
        <div class="nav-card active" id="card-best" onclick="displayRoute('best')">
            <h4 id="h-best">èˆ’é€‚æœ€ä¼˜</h4>
            <div class="desc" id="d-best">è®¡ç®—ä¸­...</div>
        </div>
        <div class="nav-card" id="card-alt1" onclick="displayRoute('alt1')">
            <h4>æœ€çŸ­è·ç¦»</h4>
            <div class="desc" id="d-alt1">â€”â€”</div>
        </div>
        <div class="nav-card" id="card-alt2" onclick="displayRoute('alt2')">
            <h4>å¤‡é€‰è·¯çº¿</h4>
            <div class="desc" id="d-alt2">â€”â€”</div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/geojson-path-finder/dist/geojson-path-finder.min.js"></script>

<script>
    // 1. åˆå§‹åŒ–
    const imageBounds = [[22.525063791, 113.92663566], [22.5394650408, 113.946736297]];
    const map = L.map('map', { 
        maxBounds: imageBounds, 
        zoomControl: false,
        attributionControl: false,
        tap: true 
    }).setView([22.532, 113.936], 16);
    
    const groundLayer = L.imageOverlay('szu_base.png', imageBounds, { interactive: true }).addTo(map);

    let isNight = false, roadsData, pointsData, userLocation = null;
    let routes = { best: null, alt1: null, alt2: null };
    let currentLayers = [];

    // 2. åŠ è½½ä¸æ¸…æ´—
    Promise.all([
        fetch('roads.json').then(r => r.json()),
        fetch('points.json').then(r => r.json())
    ]).then(([roads, points]) => {
        roads.features.forEach((f, i) => {
            f.properties.id = f.properties.id || `r_${i}`;
            f.geometry.coordinates = f.geometry.coordinates.map(c => [parseFloat(c[0]), parseFloat(c[1])]);
        });
        roadsData = roads;
        pointsData = points;
        const list = document.getElementById('pointsList');
        points.features.forEach(f => {
            const opt = document.createElement('option');
            opt.value = f.properties.name;
            list.appendChild(opt);
        });
    });

    // 3. å¯¼èˆªè§¦å‘æ§åˆ¶
    function triggerNav() {
        const val = document.getElementById('destInput').value;
        if(!val) return alert("è¯·è¾“å…¥ç›®çš„åœ°");
        
        // å¦‚æœæ²¡æœ‰å®šä½ï¼Œå…ˆå°è¯•å®šä½ä¸€æ¬¡
        if(!userLocation) {
            document.getElementById('status-bar').innerText = "å°è¯•è·å–å®šä½...";
            requestLocation();
            // å»¶è¿Ÿä¸€ç‚¹ç‚¹ç­‰å®šä½
            setTimeout(() => startNavigation(val), 1000);
        } else {
            startNavigation(val);
        }
    }

    function checkInput(val) {
        if(pointsData.features.some(f => f.properties.name === val)) {
            startNavigation(val);
        }
    }

    // 4. å®šä½é€»è¾‘ (iOS å…¼å®¹)
    function requestLocation() {
        map.locate({ setView: true, enableHighAccuracy: true });
    }

    map.on('locationfound', e => {
        userLocation = e.latlng;
        updateUserMarker(e.latlng);
        document.getElementById('status-bar').innerText = "å®šä½æˆåŠŸ";
    });

    map.on('click', e => {
        userLocation = e.latlng;
        updateUserMarker(e.latlng);
        document.getElementById('status-bar').innerText = "èµ·ç‚¹å·²è®¾ä¸ºç‚¹å‡»å¤„";
    });

    function updateUserMarker(latlng) {
        if(!window.userMarker) {
            window.userMarker = L.circleMarker(latlng, {radius: 8, color: '#fff', weight: 2, fillColor: '#007AFF', fillOpacity: 1}).addTo(map);
        } else {
            window.userMarker.setLatLng(latlng);
        }
    }

    // 5. æ ¸å¿ƒå¯¼èˆªä¸åŠ¨ç”»é€»è¾‘
    function startNavigation(name) {
        if(!userLocation) return alert("è¯·å…ˆç‚¹å‡»å³ä¸‹è§’ ğŸ¯ å®šä½ï¼Œæˆ–ç‚¹å‡»åœ°å›¾è®¾ç½®èµ·ç‚¹");
        
        const target = pointsData.features.find(f => f.properties.name === name);
        if(!target) return;

        try {
            const finder = new geojsonPathFinder(roadsData, {
                weightFn: (a, b, props) => props.length * (penaltyIds.includes(props.id) ? 50 : 1)
            });

            // è®¡ç®—ä¸‰æ¡è·¯ï¼ˆç®€åŒ–æƒé‡ä»…æ¼”ç¤ºåˆ‡æ¢ï¼‰
            const r1 = calculateSingle('best', target.geometry.coordinates);
            if(!r1) throw new Error();
            routes.best = r1;
            routes.alt1 = calculateSingle('alt', target.geometry.coordinates, r1.edgeInfos.map(e=>e.id));
            
            // åŠ¨ç”»å¼€å¯ï¼šæ˜¾ç¤ºé¢æ¿ï¼Œç¼©å°åœ°å›¾
            document.getElementById('bottomNav').classList.add('show');
            document.getElementById('map').classList.add('shrink');
            document.getElementById('locateBtn').classList.add('up');
            
            displayRoute('best');
            updateUI();
        } catch (e) {
            alert("è§„åˆ’å¤±è´¥ï¼šèµ·ç‚¹è·ç¦»è·¯ç½‘è¿‡è¿œ");
        }
    }

    function calculateSingle(type, dest, penalty = []) {
        const f = new geojsonPathFinder(roadsData, {
            weightFn: (a, b, p) => p.length * (penalty.includes(p.id) ? 20 : 1)
        });
        return f.findPath({geometry:{coordinates:[userLocation.lng, userLocation.lat]}}, {geometry:{coordinates:dest}});
    }

    function displayRoute(type) {
        currentLayers.forEach(l => map.removeLayer(l));
        currentLayers = [];
        document.querySelectorAll('.nav-card').forEach(c => c.classList.remove('active'));
        document.getElementById('card-' + type).classList.add('active');
        const r = routes[type];
        if(r) {
            const poly = L.polyline(r.path.map(p => [p[1], p[0]]), {color: '#800000', weight: 8, opacity: 0.8}).addTo(map);
            currentLayers.push(poly);
            map.fitBounds(poly.getBounds(), {padding: [30, 30]});
        }
    }

    function updateUI() {
        ['best', 'alt1', 'alt2'].forEach(t => {
            const r = routes[t];
            if(r) document.getElementById('d-'+t).innerText = `é¢„è®¡ ${Math.round(r.weight*100)} ç±³`;
        });
    }

    function toggleTheme() {
        isNight = !isNight;
        document.body.classList.toggle('dark-mode');
        const img = groundLayer.getElement();
        if(img) img.style.filter = isNight ? "brightness(0.4) contrast(1.2) hue-rotate(180deg)" : "none";
    }
</script>
</body>
</html>