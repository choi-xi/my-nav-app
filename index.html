<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>æ·±å¤§æ™ºèƒ½å¯¼èˆªç³»ç»Ÿ - æœ€ç»ˆé›†æˆç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        :root { --bg: #ffffff; --text: #333; --panel: rgba(255,255,255,0.95); --accent: #800000; }
        body.dark-mode { --bg: #121212; --text: #e0e0e0; --panel: rgba(30,30,30,0.95); --accent: #ff4d4d; }
        
        body { margin: 0; transition: background 0.8s ease; background: var(--bg); font-family: -apple-system, sans-serif; overflow: hidden; }
        #map { height: 60vh; width: 100vw; background: #f0f0f0; transition: filter 0.8s ease; }
        body.dark-mode #map { background: #0a0a0a; }

        /* é¡¶éƒ¨ç»„ä»¶ */
        .top-bar { position: absolute; top: 15px; width: 90%; left: 5%; z-index: 1000; display: flex; gap: 10px; }
        #destInput { flex: 1; padding: 12px 20px; border-radius: 25px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.15); font-size: 16px; background: var(--panel); color: var(--text); outline: none; }
        .theme-btn { background: var(--panel); border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; }

        /* åº•éƒ¨å¯¼èˆªå¡ç‰‡ */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 40vh; background: var(--panel); color: var(--text); display: flex; flex-direction: column; border-top: 1px solid rgba(0,0,0,0.1); z-index: 1001; }
        .nav-tabs { display: flex; height: 100%; }
        .nav-card { flex: 1; padding: 15px 10px; border-right: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; cursor: pointer; transition: 0.3s; }
        .nav-card.active { background: rgba(128, 0, 0, 0.08); border-top: 4px solid var(--accent); }
        .nav-card h4 { margin: 0 0 8px 0; font-size: 14px; color: var(--accent); }
        .nav-card .desc { font-size: 11px; line-height: 1.5; color: #666; overflow-y: auto; flex-grow: 1; }
        body.dark-mode .nav-card .desc { color: #bbb; }

        .custom-popup .leaflet-popup-content-wrapper { background: var(--panel); color: var(--text); border-radius: 12px; }
        .nav-btn { background: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-top: 10px; cursor: pointer; width: 100%; font-weight: bold; }
    </style>
</head>
<body>

<div class="top-bar">
    <input type="text" id="destInput" list="pointsList" placeholder="æœç´¢æ·±å¤§åœ°ç‚¹..." oninput="checkInput(this.value)">
    <datalist id="pointsList"></datalist>
    <button class="theme-btn" onclick="toggleTheme()">ğŸŒ“</button>
</div>

<div id="map"></div>

<div class="bottom-nav">
    <div class="nav-tabs">
        <div class="nav-card" id="card-best" onclick="displayRoute('best')">
            <h4 id="h-best">èˆ’é€‚æœ€ä¼˜</h4>
            <div class="desc" id="d-best">ç‚¹å‡»åœ°å›¾ä¸Šçš„ç‚¹æˆ–æœç´¢å¼€å§‹å¯¼èˆª</div>
        </div>
        <div class="nav-card" id="card-alt1" onclick="displayRoute('alt1')">
            <h4 id="h-alt1">å¤‡é€‰ï¼šæ›´çŸ­</h4>
            <div class="desc" id="d-alt1">â€”â€”</div>
        </div>
        <div class="nav-card" id="card-alt2" onclick="displayRoute('alt2')">
            <h4 id="h-alt2">å¤‡é€‰ï¼šæ›´å®‰å…¨</h4>
            <div class="desc" id="d-alt2">â€”â€”</div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/geojson-path-finder/dist/geojson-path-finder.min.js"></script>

<script>
    // 1. åˆå§‹åŒ–åº•å›¾èŒƒå›´ï¼ˆä½¿ç”¨ä½ åˆšæ‰è„šæœ¬è¾“å‡ºçš„ç²¾ç¡®åæ ‡ï¼‰
    const imageBounds = [[22.525063791, 113.92663566], [22.5394650408, 113.946736297]];
    
    const map = L.map('map', { 
        maxBounds: imageBounds, 
        maxBoundsViscosity: 1.0,
        minZoom: 15 
    }).setView([22.532, 113.936], 16);

    // åŠ è½½ä½ çš„é«˜æ¸…åº•å›¾
    const groundLayer = L.imageOverlay('szu_base.png', imageBounds, {
        opacity: 1,
        zIndex: 1,
        interactive: true
    }).addTo(map);

    let isNight = false, roadsData, pointsData, userLocation;
    let routes = { best: null, alt1: null, alt2: null };
    let currentLayers = [];

    // 2. åŠ è½½è·¯ç½‘ä¸ç‚¹æ•°æ®
    Promise.all([
        fetch('roads.json').then(r => r.json()),
        fetch('points.json').then(r => r.json())
    ]).then(([roads, points]) => {
        roadsData = roads;
        pointsData = points;
        
        const list = document.getElementById('pointsList');
        L.geoJSON(points, {
            pointToLayer: (f, l) => {
                const opt = document.createElement('option');
                opt.value = f.properties.name;
                list.appendChild(opt);
                return L.circleMarker(l, { radius: 5, color: 'transparent', fillColor: '#800000', fillOpacity: 0.5 });
            },
            onEachFeature: (f, layer) => {
                const content = `<b>${f.properties.name}</b><br><button class="nav-btn" onclick="startNavigation('${f.properties.name}')">åˆ°è¿™é‡Œå»</button>`;
                layer.bindPopup(content, { className: 'custom-popup' });
            }
        }).addTo(map);
    });

    // 3. å®æ—¶å®šä½
    map.on('locationfound', e => {
        userLocation = e.latlng;
        if(!window.userMarker) {
            window.userMarker = L.circleMarker(e.latlng, {radius: 8, color: '#fff', weight: 2, fillColor: '#007AFF', fillOpacity: 1}).addTo(map);
        } else {
            window.userMarker.setLatLng(e.latlng);
        }
    });
    map.locate({setView: true, watch: true, enableHighAccuracy: true});

    // 4. ç™½å¤©é»‘å¤œåŠ¨ç”»åˆ‡æ¢
    function toggleTheme() {
        isNight = !isNight;
        document.body.classList.toggle('dark-mode');
        
        // åº•å›¾æ»¤é•œåŠ¨ç”»
        const mapImg = groundLayer.getElement();
        if(mapImg) {
            mapImg.style.transition = "filter 1.2s ease";
            mapImg.style.filter = isNight ? "brightness(0.4) contrast(1.3) hue-rotate(190deg) saturate(0.6)" : "none";
        }

        document.getElementById('h-best').innerText = isNight ? "æ›´å®‰å…¨(æœ€ä¼˜)" : "èˆ’é€‚æœ€ä¼˜";
        if(document.getElementById('destInput').value) startNavigation(document.getElementById('destInput').value);
    }

    function checkInput(val) {
        const found = pointsData.features.some(f => f.properties.name === val);
        if(found) startNavigation(val);
    }

    // 5. æ ¸å¿ƒå¯¼èˆªé€»è¾‘ï¼šåŒ…å«æ’ä»–æ€§è°ƒæ•´
    async function startNavigation(name) {
        document.getElementById('destInput').value = name;
        const target = pointsData.features.find(f => f.properties.name === name);
        if(!target || !userLocation) return;
        map.closePopup();

        // è®¡ç®—ä¸‰æ¡è·¯å¾„ï¼Œåˆ©ç”¨ä¸Šä¸€ä¸ªè·¯å¾„çš„ id é›†åˆè¿›è¡Œæ’ä»–æƒ©ç½š
        routes.best = calculatePath('best', target.geometry.coordinates);
        
        const bestIds = routes.best ? routes.best.edgeInfos.map(e => e.id) : [];
        routes.alt1 = calculatePath('alt1', target.geometry.coordinates, bestIds);
        
        const allUsedIds = [...bestIds, ...(routes.alt1 ? routes.alt1.edgeInfos.map(e => e.id) : [])];
        routes.alt2 = calculatePath('alt2', target.geometry.coordinates, allUsedIds);

        updateUI();
        displayRoute('best');
    }

    function calculatePath(type, destCoords, penaltyIds = []) {
        let lBoost = 0;
        let result = null;
        
        const compute = (boost) => {
            const pFinder = new geojsonPathFinder(roadsData, {
                weightFn: (a, b, props) => {
                    const { length: L, width: W, env: E, safe: S } = props;
                    const isUsed = penaltyIds.includes(props.id);
                    const penalty = isUsed ? 50 : 1; // æƒ©ç½šç³»æ•°

                    let w = 0;
                    if(!isNight){ // ç™½å¤©
                        if(type === 'best') w = (L*0.2 + W*0.2 + E*0.4 + S*0.2);
                        if(type === 'alt1') w = ((L+boost)*0.5 + W*0.2 + E*0.3);
                        if(type === 'alt2') w = ((L+boost)*0.3 + W*0.3 + S*0.4);
                    } else { // é»‘å¤œ
                        if(type === 'best') w = (L*0.2 + W*0.2 + E*0.2 + S*0.4);
                        if(type === 'alt1') w = ((L+boost)*0.5 + W*0.2 + S*0.3);
                        if(type === 'alt2') w = ((L+boost)*0.2 + W*0.2 + S*0.2 + E*0.4);
                    }
                    return w * penalty;
                }
            });
            return pFinder.findPath({geometry:{coordinates:[userLocation.lng, userLocation.lat]}}, {geometry:{coordinates:destCoords}});
        };

        result = compute(0);
        // å¦‚æœå¤‡é€‰è·¯å¾„å’Œå·²é€‰è·¯å¾„é‡åˆåº¦è¿‡é«˜ï¼Œè°ƒæ•´ length é‡æ–°ç®—
        if(type !== 'best' && result && penaltyIds.length > 0) {
            let retry = 0;
            while(retry < 3 && result.edgeInfos.filter(e => penaltyIds.includes(e.id)).length > (result.edgeInfos.length * 0.5)) {
                lBoost += 0.8; 
                result = compute(lBoost);
                retry++;
            }
        }
        return result;
    }

    function displayRoute(type) {
        currentLayers.forEach(l => map.removeLayer(l));
        currentLayers = [];
        document.querySelectorAll('.nav-card').forEach(c => c.classList.remove('active'));
        document.getElementById('card-' + type).classList.add('active');

        const r = routes[type];
        if(r) {
            const color = type === 'best' ? '#800000' : (type === 'alt1' ? '#007AFF' : '#34C759');
            const poly = L.polyline(r.path.map(p => [p[1], p[0]]), {color, weight: 8, opacity: 0.85, lineJoin: 'round'}).addTo(map);
            currentLayers.push(poly);
            map.fitBounds(poly.getBounds(), {padding: [60, 60]});
        }
    }

    function updateUI() {
        const labels = {
            best: isNight ? "å®‰å…¨æœ€ä¼˜ï¼šå…‰ç…§å¥½" : "èˆ’é€‚æœ€ä¼˜ï¼šç»¿åŒ–å¥½",
            alt1: "å¤‡é€‰ï¼šè·ç¦»æœ€è¿‘",
            alt2: isNight ? "å¤‡é€‰ï¼šç¯å¢ƒè¾ƒå¥½" : "å¤‡é€‰ï¼šå®‰å…¨æ€§æœ€é«˜"
        };
        ['best', 'alt1', 'alt2'].forEach(t => {
            const r = routes[t];
            const div = document.getElementById('d-'+t);
            if(r) {
                const avgW = (r.edgeInfos.reduce((a,b)=>a+(b.width||0),0)/r.edgeInfos.length).toFixed(1);
                div.innerHTML = `<b>${labels[t]}</b><br>é¢„è®¡: ${(r.weight*100).toFixed(0)}ç±³<br>å¹³å‡è·¯å®½: ${avgW}ç±³`;
            } else {
                div.innerHTML = "æ— æ³•è§„åˆ’æ­¤è·¯çº¿";
            }
        });
    }
</script>
</body>
</html>